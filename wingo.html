<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Wingo - Winplay</title>
  <link rel="stylesheet" href="./style.css"/>
</head>
<body>
  <div class="nav">
    <div class="nav-inner">
      <div class="brand"><span class="logo">W</span> WINPLAY <span class="badge">WINGO 1M</span></div>
      <div class="nav-links">
        <a class="pill" href="./index.html">Lobby</a>
        <a class="pill" href="./wallet.html">Wallet</a>
        <a class="pill" href="./deposit.html">Deposit</a>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="muted">点数余额</div>
          <div class="kpi" id="bal">0</div>
        </div>
        <div style="text-align:right">
          <div class="muted">倒计时</div>
          <div class="kpi" id="timer">60</div>
        </div>
      </div>
      <hr/>
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="muted">本局期号</div>
          <div class="kpi" id="round">—</div>
        </div>
        <div style="text-align:right">
          <div class="muted">上期开奖结果</div>
          <div class="kpi" id="last">—</div>
        </div>
      </div>

      <div style="margin-top:12px" class="row">
        <div style="flex:1;min-width:220px">
          <div class="small">下注点数</div>
          <input class="input" id="stake" placeholder="例如 100" inputmode="numeric"/>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn" onclick="bet('BIG')">下注 大（5-9） x2</button>
        <button class="btn btn-ghost" onclick="bet('SMALL')">下注 小（0-4） x2</button>
      </div>
      <div class="small" id="msg" style="margin-top:10px"></div>
    </div>

    <div class="card" style="margin-top:14px">
      <h2 style="margin:0 0 6px">最近 10 期</h2>
      <table class="table">
        <thead><tr><th>期号</th><th>结果</th><th>你的下注</th><th>结算</th></tr></thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

<script>
  const USERS="wp_users";
  const SESSION="wp_session";
  const LOGS="wp_logs";
  const WKEY="wp_wingo";

  function loadUsers(){ return JSON.parse(localStorage.getItem(USERS)||"[]"); }
  function saveUsers(arr){ localStorage.setItem(USERS, JSON.stringify(arr)); }
  function getSession(){ return JSON.parse(localStorage.getItem(SESSION)||"null"); }
  function currentUser(){
    const s=getSession(); if(!s) return null;
    return loadUsers().find(u=>u.email===s.email) || null;
  }
  function updateUser(u){
    const users=loadUsers();
    const i=users.findIndex(x=>x.email===u.email);
    users[i]=u; saveUsers(users);
  }
  function addLog(email, type, delta){
    const arr=JSON.parse(localStorage.getItem(LOGS)||"[]");
    arr.unshift({t:new Date().toLocaleString(), email, type, delta});
    localStorage.setItem(LOGS, JSON.stringify(arr.slice(0,200)));
  }

  function state(){
    return JSON.parse(localStorage.getItem(WKEY)||"null") || {
      round: 1,
      endsAt: Date.now() + 60000,
      lastResult: null,
      history: [],
      bets: {} // email -> {round, side, stake}
    };
  }
  function save(s){ localStorage.setItem(WKEY, JSON.stringify(s)); }

  function ensure(){
    const u=currentUser();
    if(!u) location.href="./auth.html";
    document.getElementById("bal").textContent = u.balance;
  }

  function bet(side){
    const u=currentUser(); if(!u) return location.href="./auth.html";
    const st = state();
    const stake = parseInt(document.getElementById("stake").value||"0",10);
    if(!stake || stake<=0) return alert("请输入下注点数");
    if(stake > u.balance) return alert("余额不足");

    // only allow 1 bet per round per user (demo rule)
    st.bets[u.email] = {round: st.round, side, stake};
    u.balance -= stake;
    updateUser(u);
    addLog(u.email, "Wingo Bet", `-${stake} (${side})`);
    save(st);

    document.getElementById("bal").textContent = u.balance;
    document.getElementById("msg").textContent = `已下注：${side} / ${stake} 点（本局 ${st.round}）`;
  }

  function settleIfNeeded(){
    const st = state();
    const now = Date.now();
    if(now < st.endsAt) return;

    // draw result 0-9
    const result = Math.floor(Math.random()*10);
    const roundId = st.round;

    // settle bets
    const users = loadUsers();
    const payouts = [];
    for(const email in st.bets){
      const b = st.bets[email];
      if(b.round !== roundId) continue;
      const u = users.find(x=>x.email===email);
      if(!u) continue;

      const winSide = (result >=5) ? "BIG" : "SMALL";
      let settle = `LOSE -${b.stake}`;
      if(b.side === winSide){
        const win = b.stake * 2;
        u.balance += win;
        addLog(email, "Wingo Win", `+${win} (${winSide})`);
        settle = `WIN +${win}`;
      }else{
        addLog(email, "Wingo Lose", `-${b.stake}`);
      }
      payouts.push({email, bet:`${b.side}/${b.stake}`, settle});
    }
    saveUsers(users);

    // write history
    st.history.unshift({round: roundId, result, payouts});
    st.history = st.history.slice(0,10);
    st.lastResult = result;

    // next round
    st.round += 1;
    st.endsAt = Date.now() + 60000;
    st.bets = {};
    save(st);
    render();
  }

  function render(){
    const u=currentUser(); if(!u) return;
    const st = state();
    document.getElementById("round").textContent = st.round;
    document.getElementById("last").textContent = st.lastResult===null ? "—" : st.lastResult;
    document.getElementById("bal").textContent = u.balance;

    const rows = st.history.map(h=>{
      const my = (h.payouts||[]).find(p=>p.email===u.email);
      const myBet = my ? my.bet : "—";
      const mySet = my ? my.settle : "—";
      return `<tr><td>${h.round}</td><td>${h.result}</td><td>${myBet}</td><td>${mySet}</td></tr>`;
    }).join("");
    document.getElementById("rows").innerHTML = rows || `<tr><td colspan="4" class="small">暂无记录</td></tr>`;
  }

  function tick(){
    const st = state();
    const left = Math.max(0, Math.ceil((st.endsAt - Date.now())/1000));
    document.getElementById("timer").textContent = left;
    settleIfNeeded();
  }

  ensure();
  render();
  setInterval(tick, 250);
</script>
</body>
</html>
