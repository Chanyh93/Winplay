<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Crash - MZ PLAY</title>
  <link rel="stylesheet" href="./style.css"/>
</head>
<body>
  <div class="nav">
    <div class="nav-inner">
      <div class="brand">MZ PLAY <span class="badge">CRASH</span></div>
      <div class="nav-links">
        <a class="pill" href="./index.html">Lobby</a>
        <a class="pill" href="./wallet.html">Wallet</a>
        <a class="pill" href="./deposit.html">Deposit</a>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:flex-end">
        <div>
          <div class="muted">ç‚¹æ•°ä½™é¢</div>
          <div class="kpi" id="bal">0</div>
        </div>
        <div style="text-align:right">
          <div class="muted">å½“å‰å€ç‡</div>
          <div class="kpi" id="mult">1.00x</div>
        </div>
      </div>

      <div style="margin-top:14px; padding:14px; border-radius:16px; border:1px solid rgba(255,255,255,.08); background:rgba(0,0,0,.22)">
        <div class="row" style="justify-content:space-between">
          <div>
            <div class="muted">çŠ¶æ€</div>
            <div class="kpi" id="status" style="font-size:18px">READY</div>
          </div>
          <div>
            <div class="muted">æœ¬å±€çˆ†ç‚¹</div>
            <div class="kpi" id="bust">?</div>
          </div>
        </div>
      </div>

      <div class="row" style="margin-top:14px">
        <div style="flex:1; min-width:220px">
          <div class="small">ä¸‹æ³¨ç‚¹æ•°</div>
          <input class="input" id="stake" placeholder="ä¾‹å¦‚ 100" inputmode="numeric"/>
        </div>
        <div style="flex:1; min-width:220px">
          <div class="small">è‡ªåŠ¨æç°å€ç‡ï¼ˆå¯ç©ºï¼‰</div>
          <input class="input" id="auto" placeholder="ä¾‹å¦‚ 2.00" inputmode="decimal"/>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnBet" onclick="placeBet()">ä¸‹æ³¨å¼€å§‹</button>
        <button class="btn btn-ghost" id="btnCash" onclick="cashout()" disabled>Cashout</button>
        <button class="btn btn-ghost" onclick="location.href='./wallet.html'">å» Wallet</button>
      </div>

      <div class="small" id="msg" style="margin-top:10px"></div>
    </div>

    <div class="card" style="margin-top:14px">
      <div class="h1" style="font-size:22px;margin:0">æœ€è¿‘ 10 å±€ï¼ˆæœ¬åœ°ï¼‰</div>
      <table class="table">
        <thead><tr><th>æ—¶é—´</th><th>çˆ†ç‚¹</th><th>ç»“æœ</th></tr></thead>
        <tbody id="history"></tbody>
      </table>
    </div>
  </div>

<script>
  const BAL="mz_balance";
  const LOG="mz_log";
  const HIS="mz_crash_history";

  let running=false, interval=null;
  let current=1.00;
  let bustAt=0;
  let betStake=0;
  let cashed=false;
  let autoCash=null;

  function nowStr(){ return new Date().toLocaleString(); }
  function getBal(){
    if(!localStorage.getItem(BAL)) localStorage.setItem(BAL,"5000");
    return parseInt(localStorage.getItem(BAL)||"0",10);
  }
  function setBal(v){ localStorage.setItem(BAL,String(v)); document.getElementById("bal").textContent=v; }
  function addLog(type, delta){
    const arr = JSON.parse(localStorage.getItem(LOG)||"[]");
    arr.unshift({t: nowStr(), type, delta});
    localStorage.setItem(LOG, JSON.stringify(arr.slice(0,50)));
  }
  function pushHistory(item){
    const arr = JSON.parse(localStorage.getItem(HIS)||"[]");
    arr.unshift(item);
    localStorage.setItem(HIS, JSON.stringify(arr.slice(0,10)));
    renderHistory();
  }
  function renderHistory(){
    const arr = JSON.parse(localStorage.getItem(HIS)||"[]");
    document.getElementById("history").innerHTML = arr.map(x =>
      `<tr><td>${x.t}</td><td>${x.bust.toFixed(2)}x</td><td>${x.result}</td></tr>`
    ).join("");
  }

  // ç”Ÿæˆçˆ†ç‚¹ï¼šåå‘ä½å€æ•°ï¼ˆæ›´åƒçœŸå® crash çš„ä½“éªŒï¼‰
  function genBust(){
    const r = Math.random();
    // å¤§å¤šæ•°åœ¨ 1.0~3.0ï¼Œå¶å°”é«˜ä¸€ç‚¹
    let b = 1 + Math.pow(r, 2.6) * 12;
    if (Math.random() < 0.02) b = 10 + Math.random()*40; // æå°‘æ•°è¶…é«˜
    return Math.max(1.01, Math.min(b, 60));
  }

  function setStatus(s){ document.getElementById("status").textContent = s; }
  function setMsg(s){ document.getElementById("msg").textContent = s; }

  function placeBet(){
    if(running) return;
    const stake = parseInt(document.getElementById("stake").value||"0",10);
    if(!stake || stake<=0){ alert("è¯·è¾“å…¥ä¸‹æ³¨ç‚¹æ•°"); return; }
    const bal = getBal();
    if(stake > bal){ alert("ä½™é¢ä¸è¶³"); return; }

    autoCash = null;
    const a = (document.getElementById("auto").value||"").trim();
    if(a){
      const ax = Number(a);
      if(!isFinite(ax) || ax < 1.01) { alert("è‡ªåŠ¨å€ç‡è¦ >= 1.01"); return; }
      autoCash = ax;
    }

    betStake = stake;
    cashed = false;
    bustAt = genBust();
    current = 1.00;

    setBal(bal - stake);
    addLog("Crash Bet", `-${stake}`);
    document.getElementById("bust").textContent = "?";
    document.getElementById("btnBet").disabled = true;
    document.getElementById("btnCash").disabled = false;

    running = true;
    setStatus("FLYING...");
    tick();
    interval = setInterval(tick, 80);
  }

  function tick(){
    // å€ç‡å¢é•¿ï¼ˆå…ˆå¿«åæ…¢ï¼‰
    const inc = 0.01 + (0.06 / (1 + current*0.35));
    current = +(current + inc).toFixed(2);
    document.getElementById("mult").textContent = current.toFixed(2) + "x";

    if(autoCash && !cashed && current >= autoCash){
      cashout(true);
      return;
    }

    if(current >= bustAt){
      bust();
    }
  }

  function cashout(isAuto=false){
    if(!running || cashed) return;
    cashed = true;

    const win = Math.floor(betStake * current);
    const bal = getBal();
    setBal(bal + win);
    addLog("Crash Cashout", `+${win}`);

    clearInterval(interval);
    running = false;
    document.getElementById("btnBet").disabled = false;
    document.getElementById("btnCash").disabled = true;

    document.getElementById("bust").textContent = bustAt.toFixed(2) + "x";
    setStatus(isAuto ? "AUTO CASHOUT âœ…" : "CASHOUT âœ…");
    setMsg(`èµ¢å¾— ${win} ç‚¹ï¼ˆå€ç‡ ${current.toFixed(2)}xï¼‰`);
    pushHistory({t:nowStr(), bust:bustAt, result:`WIN +${win}`});
  }

  function bust(){
    clearInterval(interval);
    running = false;
    document.getElementById("btnBet").disabled = false;
    document.getElementById("btnCash").disabled = true;

    document.getElementById("bust").textContent = bustAt.toFixed(2) + "x";
    setStatus("BUST ğŸ’¥");
    setMsg(`çˆ†äº†ï¼æœ¬å±€è¾“æ‰ ${betStake} ç‚¹`);
    pushHistory({t:nowStr(), bust:bustAt, result:`LOSE -${betStake}`});
  }

  // init
  setBal(getBal());
  renderHistory();
</script>
</body>
</html>
